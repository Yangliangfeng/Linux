### HTTPS协议原理大揭秘

* 关于加密问题
```
  HTTPS 在内容传输的加密上使用的是对称加密，非对称加密只作用在证书验证阶段
```
* HTTPS 整体的传输过程
```
1. 证书验证
    1) 浏览器发起 HTTPS 请求
    2) 服务端返回 HTTPS 证书
    3) 客户端验证证书是否合法，如果不合法则提示告警
    
2. 数据传输阶段
    1) 当证书验证合法后，在本地生成随机数
    2) 客户端通过公钥加密随机数，并把加密后的随机数传输到服务端
    3）服务端通过私钥对随机数进行解密
    4）服务端通过客户端传入的随机数构造对称加密算法，对返回结果内容进行加密后传输
```
* 为什么数据传输是用对称加密
```
1. 非对称加密的加解密效率是非常低的，而 HTTP 的应用场景中通常端与端之间存在大量的交互，非对称加密的效率是无法接受的

2. 在 HTTPS 的场景中只有服务端保存了私钥，一对公私钥只能实现单向的加解密，所以HTTPS 中内容传输加密采取的是对称加密，

   而不是非对称加密
```
* 攻击的流程

![](https://github.com/Yangliangfeng/Linux/raw/master/file/images/https.png)

```
1. 本地请求被劫持（如 DNS 劫持等），所有请求均发送到中间人的服务器

2. 中间人服务器返回中间人自己的证书

3. 客户端创建随机数，通过中间人证书的公钥对随机数加密后传送给中间人，然后凭随机数构造对称加密对传输内容进行加密传输

4. 中间人因为拥有客户端的随机数，可以通过对称加密算法进行内容解密

5. 中间人以客户端的请求内容再向正规网站发起请求

6. 因为中间人与服务器的通信过程是合法的，正规网站通过建立的安全通道返回加密后的数据

7. 中间人凭借与正规网站建立的对称加密算法对内容进行解密

8. 中间人通过与客户端建立的对称加密算法对正规内容返回的数据进行加密传输

9. 客户端通过与中间人建立的对称加密算法对返回结果数据进行解密

由于缺少对证书的验证，所以客户端虽然发起的是 HTTPS 请求，但客户端完全不知道自己的网络已被拦截，传输内容被中间人全部窃取
```
